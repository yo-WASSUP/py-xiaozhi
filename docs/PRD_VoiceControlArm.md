# 语音交互控制机械臂系统 - 产品需求文档 (PRD)

> 版本: v1.0 MVP
> 日期: 2026-02-05
> 状态: 草稿

---

## 1. 产品概述

### 1.1 产品定位
基于语音交互的ROS2机械臂控制系统，面向工业生产环境，提供自然语言控制、实时状态反馈、安全急停等核心能力。系统运行于边缘计算设备（Jetson，Orin NX），复用py-xiaozhi语音客户端架构和小智服务器后端。

### 1.2 核心价值
- **解放双手**: 操作人员无需触碰控制面板，语音即可控制机械臂
- **降低门槛**: 自然语言交互，无需记忆复杂指令
- **安全优先**: 毫秒级语音急停响应，多重安全机制保障
- **灵活部署**: 混合架构支持离线基础命令+在线智能对话

### 1.3 目标用户
- 工业产线操作人员
- 机械臂调试工程师
- 生产管理人员

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         边缘计算盒子 (Jetson，Orin NX)               │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────────────────┐ │
│  │  音频输入    │───▶│  语音处理模块  │───▶│    命令解析/NLU         │ │
│  │ (麦克风阵列) │    │ VAD/唤醒词/ASR│    │ (本地规则+云端LLM)      │ │
│  └─────────────┘    └──────────────┘    └───────────┬─────────────┘ │
│                                                      │               │
│  ┌─────────────┐    ┌──────────────┐    ┌───────────▼─────────────┐ │
│  │  音频输出    │◀───│  TTS语音合成  │◀───│    机械臂控制器          │ │
│  │  (扬声器)   │    │  (状态播报)   │    │  (ROS2 Action/Service)  │ │
│  └─────────────┘    └──────────────┘    └───────────┬─────────────┘ │
│                                                      │               │
│  ┌─────────────────────────────────────┐            │               │
│  │         Web控制面板 (Flask/FastAPI)  │◀───────────┘               │
│  │  状态监控 | 命令日志 | 配置管理       │                           │
│  └─────────────────────────────────────┘                            │
└────────────────────────────────────────┬────────────────────────────┘
                                         │ ROS2 DDS
                                         ▼
                              ┌─────────────────────┐
                              │   ROS2 机械臂节点    │
                              │  MoveIt2 / 控制器   │
                              └─────────────────────┘
```

### 2.2 技术栈选型

| 层级 | 技术选型 | 说明 |
|-----|---------|------|
| 硬件平台 | Jetson Orin / Xavier | GPU加速，支持本地模型推理 |
| 操作系统 | Ubuntu 22.04 + ROS2 Humble | 工业级稳定性 |
| 语音框架 | py-xiaozhi 核心模块 | 复用音频处理、协议通信 |
| 唤醒词 | Sherpa-ONNX (本地) | 离线唤醒，低延迟 |
| ASR | Sherpa-ONNX / Whisper | 本地离线识别 |
| NLU | 本地规则 + 小智服务器 | 混合架构 |
| TTS | edge-tts / 本地模型 | 状态语音播报 |
| ROS2通信 | rclpy + action/service | 标准ROS2接口 |
| Web框架 | FastAPI + Vue3 | 轻量级控制面板 |

---

## 3. 功能需求

### 3.1 MVP核心功能

#### 3.1.1 语音唤醒与监听
| 功能点 | 描述 | 验收标准 |
|-------|------|---------|
| 唤醒词激活 | 支持自定义唤醒词（默认"小智"） | 3米内唤醒成功率 > 95% |
| 按键激活 | 物理按键/快捷键触发监听 | 按下即响应 |
| VAD检测 | 自动检测语音结束 | 语音结束后500ms内停止录音 |
| 噪声抑制 | 工业环境噪声过滤 | 75dB环境下正常工作 |

#### 3.1.2 语音命令控制
| 命令类型 | 示例 | 执行方式 |
|---------|------|---------|
| 点位移动 | "移动到A点"、"去抓取位置" | 调用预设点位 |
| 轨迹执行 | "执行焊接轨迹"、"运行装配程序" | 执行预录轨迹 |
| 抓取操作 | "抓取"、"松开"、"夹紧" | 控制夹爪 |
| 速度控制 | "慢一点"、"加速到50%" | 调整运动速度 |
| 坐标移动 | "向左移动10厘米" | 相对坐标移动 |

#### 3.1.3 紧急语音控制 (最高优先级)
| 命令 | 响应时间 | 处理方式 |
|-----|---------|---------|
| "停"/"停止"/"急停" | < 200ms | 立即中断当前动作，触发急停 |
| "暂停" | < 300ms | 暂停当前轨迹，可恢复 |
| "继续" | < 300ms | 恢复暂停的动作 |

**实现要点**:
- 急停命令走独立的本地识别通道，不经过云端
- 使用关键词检测(KWS)而非完整ASR，确保极低延迟
- 急停状态下所有其他命令失效，直到手动解除

#### 3.1.4 状态查询与反馈
| 查询类型 | 示例 | 反馈方式 |
|---------|------|---------|
| 位置查询 | "当前位置"、"在哪里" | 语音播报坐标/点位名 |
| 状态查询 | "什么状态"、"在干什么" | 播报当前运动状态 |
| 错误查询 | "什么故障" | 播报最近错误信息 |

#### 3.1.5 示教记录 (MVP简化版)
| 功能 | 命令示例 | 说明 |
|-----|---------|------|
| 记录点位 | "记住这个位置叫B点" | 保存当前关节角度 |
| 开始录制 | "开始记录轨迹" | 录制后续运动 |
| 停止录制 | "停止录制，保存为轨迹1" | 保存轨迹 |

### 3.2 安全机制

#### 3.2.1 语音急停优先级
```
优先级 0 (最高): 急停命令 - 本地KWS直接触发，绕过所有处理
优先级 1: 暂停/继续 - 本地快速处理
优先级 2: 运动命令 - 正常ASR+NLU流程
优先级 3: 查询命令 - 可排队处理
```

#### 3.2.2 命令确认机制
- 危险操作需语音确认: "确定要执行高速运动吗？请说确认"
- 可配置的确认命令列表
- 超时未确认自动取消

#### 3.2.3 语音认证
- 可选的声纹识别功能
- 支持配置授权操作员列表
- 未授权人员只能执行查询操作

#### 3.2.4 操作日志
- 记录所有语音命令和识别结果
- 记录命令执行状态和结果
- 支持日志查询和导出

### 3.3 Web控制面板

#### 3.3.1 状态监控页
- 机械臂实时状态（位置、速度、负载）
- 语音模块状态（监听中/处理中/空闲）
- 系统资源监控（CPU/GPU/内存）

#### 3.3.2 命令日志页
- 实时命令流显示
- 识别结果和置信度
- 执行状态和错误信息
- 筛选和搜索功能

#### 3.3.3 配置管理页
- 唤醒词配置
- 预设点位管理
- 轨迹库管理
- 安全参数配置
- 授权用户管理

### 3.4 自然语言对话

通过小智服务器实现复杂意图理解:
- "把这个流程再做一遍但速度减半"

---

## 4. 非功能需求

### 4.1 性能要求

| 指标 | 要求 | 测量方式 |
|-----|------|---------|
| 唤醒响应 | < 300ms | 唤醒词结束到提示音 |
| 急停响应 | < 200ms | 命令发出到电机停止 |
| 普通命令响应 | < 500ms | 命令结束到动作开始 |
| 语音识别准确率 | > 95% | 标准工业环境 |
| 系统可用性 | > 99.5% | 24小时运行 |

### 4.2 可靠性要求

- 网络断开时基础命令仍可执行
- 服务崩溃自动重启
- 音频设备异常自动恢复
- ROS2节点断连自动重连

### 4.3 安全要求

- 所有通信加密 (TLS/DDS Security)
- 敏感配置加密存储
- 操作日志不可篡改
- 符合工业安全标准 (ISO 10218)

### 4.4 兼容性要求

- ROS2 Humble (主要支持)
- ROS2 Foxy (兼容)
- 支持标准MoveIt2接口
- 支持常见机械臂型号的ROS2驱动

---

## 5. 技术设计要点

### 5.1 复用py-xiaozhi模块

| 模块 | 复用程度 | 修改说明 |
|-----|---------|---------|
| 音频编解码 | 完全复用 | audio_codecs/* |
| VAD检测 | 完全复用 | audio_processing/vad_detector.py |
| 唤醒词检测 | 完全复用 | audio_processing/wake_word_detect.py |
| WebSocket协议 | 部分复用 | 连接小智服务器 |
| 配置管理 | 完全复用 | utils/config_manager.py |
| IoT框架 | 参考设计 | 改造为ROS2设备抽象 |

### 5.2 新增模块

```
voice_arm_control/
├── main.py                      # 入口
├── src/
│   ├── application.py           # 应用核心（参考py-xiaozhi）
│   ├── audio/                   # 音频处理（复用）
│   │   ├── audio_codec.py
│   │   ├── vad_detector.py
│   │   └── wake_word_detect.py
│   ├── asr/                     # 语音识别
│   │   ├── local_asr.py         # 本地ASR (Sherpa/Whisper)
│   │   └── emergency_kws.py     # 急停关键词检测
│   ├── nlu/                     # 自然语言理解
│   │   ├── rule_parser.py       # 本地规则解析
│   │   ├── intent_classifier.py # 意图分类
│   │   └── xiaozhi_client.py    # 小智服务器客户端
│   ├── tts/                     # 语音合成
│   │   └── tts_engine.py
│   ├── ros2/                    # ROS2集成
│   │   ├── arm_controller.py    # 机械臂控制器
│   │   ├── action_clients.py    # Action客户端
│   │   └── state_monitor.py     # 状态监控
│   ├── safety/                  # 安全模块
│   │   ├── emergency_stop.py    # 急停处理
│   │   ├── command_validator.py # 命令验证
│   │   └── voice_auth.py        # 语音认证
│   ├── web/                     # Web控制面板
│   │   ├── api.py               # FastAPI接口
│   │   └── static/              # 前端资源
│   └── utils/                   # 工具类
│       ├── config_manager.py
│       └── logger.py
├── config/
│   ├── config.yaml              # 主配置
│   ├── commands.yaml            # 命令映射配置
│   └── points.yaml              # 预设点位配置
└── models/                      # 本地模型文件
    ├── wake_word/
    └── asr/
```

### 5.3 命令处理流程

```
语音输入
    │
    ▼
┌─────────────────────┐
│  唤醒词/按键 检测    │
└─────────┬───────────┘
          │ 激活
          ▼
┌─────────────────────┐    ┌─────────────────────┐
│  并行: 急停KWS检测   │───▶│  检测到急停 → 立即  │
└─────────┬───────────┘    │  发送ROS2急停命令   │
          │                └─────────────────────┘
          │ 无急停词
          ▼
┌─────────────────────┐
│     本地ASR识别      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐     匹配成功    ┌─────────────────────┐
│   本地规则匹配       │───────────────▶│  直接执行ROS2命令    │
└─────────┬───────────┘               └─────────────────────┘
          │ 未匹配
          ▼
┌─────────────────────┐
│  小智服务器 NLU      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  意图→命令 映射      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  安全验证/确认       │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  执行ROS2命令        │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐
│  TTS语音反馈         │
└─────────────────────┘
```

### 5.4 ROS2集成设计

```python
# 机械臂控制器抽象
class ArmController:
    """ROS2机械臂控制器"""

    # Action Clients
    move_to_pose_client      # geometry_msgs/PoseStamped
    move_to_joint_client     # sensor_msgs/JointState
    execute_trajectory_client # moveit_msgs/RobotTrajectory
    gripper_command_client   # control_msgs/GripperCommand

    # Service Clients
    get_current_state_srv    # 获取当前状态
    emergency_stop_srv       # 急停服务

    # Publishers
    velocity_scale_pub       # 速度缩放

    # Subscribers
    joint_states_sub         # 关节状态
    robot_status_sub         # 机器人状态
```

---

## 6. MVP里程碑

### Phase 1: 基础语音控制 (MVP核心)
- [ ] 音频采集和唤醒词检测
- [ ] 本地ASR语音识别
- [ ] 基础命令规则解析（移动、停止、抓取）
- [ ] ROS2机械臂控制接口
- [ ] 语音急停功能
- [ ] TTS状态反馈

### Phase 2: 安全与监控
- [ ] 命令确认机制
- [ ] 操作日志记录
- [ ] Web状态监控页面
- [ ] 基础配置管理

### Phase 3: 智能对话
- [ ] 小智服务器集成
- [ ] 复杂意图理解
- [ ] 示教记录功能
- [ ] 语音认证（可选）

---

## 7. 风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 工业噪声影响识别率 | 高 | 采用麦克风阵列+波束成形 |
| 网络不稳定影响云端NLU | 中 | 混合架构，离线保底 |
| 急停响应延迟 | 高 | 独立KWS通道，最高优先级 |
| ROS2版本兼容性 | 中 | 抽象接口层，适配多版本 |

---

## 8. 附录

### 8.1 命令词表 (MVP)

**运动控制**
```
移动到{点位名} / 去{点位名} / 到{点位名}
向{方向}移动{距离} / {方向}移{距离}
执行{轨迹名} / 运行{轨迹名}
速度{百分比} / 快一点 / 慢一点
```

**夹爪控制**
```
抓取 / 夹紧 / 抓住
松开 / 释放 / 放下
```

**急停控制**
```
停 / 停止 / 急停 / stop
暂停 / 等一下
继续 / 恢复
```

**状态查询**
```
当前位置 / 在哪 / 位置
当前状态 / 什么状态 / 在干什么
什么故障 / 什么错误
```

**示教功能**
```
记住这个位置叫{名称}
保存当前位置为{名称}
开始记录轨迹
停止录制保存为{名称}
```

### 8.2 语言支持

| 语言 | 支持程度 |
|-----|---------|
| 中文（普通话） | 完整支持 |
| English | 完整支持 |

### 8.3 参考资料

- [py-xiaozhi 项目](https://github.com/huangjunsen0406/py-xiaozhi)
- [Sherpa-ONNX 语音识别](https://github.com/k2-fsa/sherpa-onnx)
- [ROS2 Humble 文档](https://docs.ros.org/en/humble/)
- [MoveIt2 文档](https://moveit.ros.org/)

---

*文档结束*
